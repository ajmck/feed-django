{% extends "_layout.html" %}
{% load static %}

{% block extrahead %}

    <link rel="stylesheet" type="text/css" href="{% static 'core/css/leafletcust.css' %}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
      integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
      crossorigin=""></script>

    {# jquery for AJAX requests #}
    <script
			  src="https://code.jquery.com/jquery-3.3.1.min.js"
			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			  crossorigin="anonymous"></script>

    <script src="{% static 'core/js/leaflet.uGeoJSON.js' %}"></script>

{% endblock extrahead %}



{% block bodywithheader %}


<div id="map" class="fillmap"></div>




<script>

    var m = L.map('map', {
        center: [-45.878, 170.502], //dunedin
        zoom: 12
    });

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ MAPBOX_KEY }}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox.streets'
    }).addTo(m);


    // add posts
    // https://medium.com/@maptastik/loading-external-geojson-a-nother-way-to-do-it-with-jquery-c72ae3b41c01

    var posts = $.ajax({
        url:"/api/geo/?format=json",
        dataType: "json",
        success: console.log("Data loaded"), //yeet
        error: function (xhr) {
            console.log(xhr.statusText)

        }
    });


    var myStyle = {
        "color": "#ff7800",
        "weight": 5,
        "opacity": 0.65
    };


    $.when(posts).done(function () {
        L.geoJSON(posts.responseJSON.results, {
            onEachFeature: function (feature, layer) {
                layer.bindPopup('<p>'+feature.properties.body+'</p>');

            }
        }).addTo(m);
    });


    L.uGeoJSONLayer({
        endpoint:"/api/meshblocks/?format=json",
        usebbox: true,
        enctype: "json",
        style: myStyle}).addTo(m);

</script>

{% endblock bodywithheader %}